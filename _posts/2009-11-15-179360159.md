---
title: "Ogre::ParticleSystem的Abstract Factory模式"
category: life
---

<p>最近在看Ogre的粒子系统的绘制方式，这里小记下。</p>
<img src="http://hiphotos.baidu.com/maxint/pic/item/7751ccdd7b0a91f78c102991.jpg">
<p>从上面的类图可以看出，Ogre::ParticleSystem是一个MovableObject，也就是说Ogre把它看成就一个可移动的场景物体。所以不可以直接创建，而是应该通过SceneManager来创建，并且只有attached到SceneNode后，才会显示。</p>
<p>为了便于ScenManager统一管理各种MovableObject，所有MovableObject使用了<a href="http://blog.csdn.net/junguo/archive/2006/04/09/655861.aspx">Abstract Factory</a>模式，并且每个子类的Factory要在Ogre::Root的mMovableObjectFactoryMap中注册，而mMovableObjectCollectionMap中存放的是各种MovableObject类的实例集合。下面就粒子系统的创建函数，常规的Abstract Factory</p>
<pre class="code">ParticleSystem* SceneManager::createParticleSystem(const String&amp; name,<br>    const String&amp; templateName)<br>{<br>    NameValuePairList params;<br>    params[&quot;templateName&quot;] = templateName;<br>    <br>    return static_cast&lt;ParticleSystem*&gt;(<br>        createMovableObject(name, ParticleSystemFactory::FACTORY_TYPE_NAME, <br>            &amp;params));<br>}</pre>
<pre class="code">MovableObject* SceneManager::createMovableObject(const String&amp; name, <br>    const String&amp; typeName, const NameValuePairList* params)<br>{<br>    // Nasty hack to make generalised Camera functions work without breaking add-on SMs<br>    if (typeName == &quot;Camera&quot;)<br>    {<br>        return createCamera(name);<br>    }<br>    MovableObjectFactory* factory = <br>        Root::getSingleton().getMovableObjectFactory(typeName);<br>    // Check for duplicate names<br>    MovableObjectCollection* objectMap = getMovableObjectCollection(typeName);<br><br>    {<br>        OGRE_LOCK_MUTEX(objectMap-&gt;mutex)<br><br>        if (objectMap-&gt;map.find(name) != objectMap-&gt;map.end())<br>        {<br>            OGRE_EXCEPT(Exception::ERR_DUPLICATE_ITEM, <br>                &quot;An object of type '&quot; + typeName + &quot;' with name '&quot; + name<br>                + &quot;' already exists.&quot;, <br>                &quot;SceneManager::createMovableObject&quot;);<br>        }<br><br>        MovableObject* newObj = factory-&gt;createInstance(name, this, params);<br>        objectMap-&gt;map[name] = newObj;<br>        return newObj;<br>    }<br>}</pre>